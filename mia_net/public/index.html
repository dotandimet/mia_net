<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <title>Mia.Net</title>
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600"
       rel="stylesheet" type="text/css">

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/skeleton.css">
  <script src="lib/mithril-0.1.21.js"></script>
  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <!-- link rel="icon" type="image/png" href="favicon.png" -->

</head>
<body>

  <!-- Primary Page Layout
  ––––––––––––––––––––––––––––––––––––––––––––––––––  -->
  <div class="container">
    <div class="row"><div id="toolbar"></div></div>
    <div class="row">
      <div class="twelve columns" id="workarea">
        <h4>Basic Page</h4>
        <p>This index.html page is a placeholder with the CSS, font and favicon. It's just waiting for you to add some content! If you need some help hit up the <a href="http://www.getskeleton.com">Skeleton documentation</a>.</p>
      </div>
    </div>
  </div>

<!--   End Document
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
</body>
  <script>
  var Mia = {};
  Mia.helpers = {};
  Mia.helpers.table = function(ctrl) {
      return m('table', [
            m('thead',
              m('tr',
                ctrl.headers.map( function(head) {
                  return m('th', head);
                })
              )
            ),
          m('tbody',
            ctrl.rows.map(function(row) {
              return m('tr',
                row.map(function(cell) { 
                  return m('td', cell)
                }) )
            } )
          ) ]);
  };

  Mia.toolbar = {};
  Mia.toolbar.controller = function() {
    this.buttons = [ { path: '/protocols', title: 'Protocols' },
                     { path: '/runs', title: 'Runs' },
                     { path: '/login', title: 'Login' } ];
    return this;
  };

  Mia.toolbar.view = function(ctrl) {
    var active = m.route();
    return ctrl.buttons.map(function(button) {
                return m('a.button', { config: m.route, href: button.path,
                style: 'margin-right: 10px',
                className: (( button.path === active ) ? 'button-primary' : '') }, button.title)
            });
  };

  Mia.login = {};
  Mia.login.User = { };
  Mia.login.controller = function() {
    this.doLogin = function() {
       m.route('/protocols');
       return false;
    }
  };
  Mia.login.view = function(ctrl) {
    return m('form', { style: 'margin-top: 5%' }, [
          m('label', {'for': 'userName'}, 'User'),
          m('input', { type: 'text', name: 'name', key: 'userName' }),
          m('label', {'for': 'passwd' }, 'Password'),
          m('input', { type: 'password', name: 'password', key: 'passwd' }),
          m('div', m('input', { type: 'submit', value: 'Login',
                              onclick: ctrl.doLogin, className: 'button-primary' }))
        ]);
  };

  Mia.protocols = {};
  Mia.protocols.Full = function() {
    return m.request({method: "GET", url: "/Protocol/list"})
    .then(function(res){ console.log(res); return res.Protocol; });
  };

  Mia.protocols.controller = function() {
    var list = Mia.protocols.Full();
    console.log(typeof list[0]);
    console.log(list[0]);
    console.log(list);
    var headers = Object.keys(list[0]);
    this.headers = headers;
    var rows = [];
    list.map(function(item) {
        var values = headers.map(function(header){
          return item[header];
        });
        rows.push(values);
    });
    this.rows = rows;
    return this;
  };

  Mia.protocols.view = function(ctrl) {
    return [ m('a.button', { href: '/protocols/create', config:
    m.route }, 'create new protocol')
    , Mia.helpers.table(ctrl) ];
  };

//model
Mia.runs = {};
Mia.runs.PageList = function() {
    return m.request({method: "GET", url: "/Unit/list"})
    .then(function(res){ return res.Unit; });
};

//controller
Mia.runs.controller = function() {
    var pages = Mia.runs.PageList();
    return {
        pages: pages,
        rotate: function() {
            pages().push(pages().shift());
        }
    }
};

//view
Mia.runs.view = function(ctrl) {
    return [
        ctrl.pages().map(function(page) {
            return m("a", {href: page.type}, page.name);
        }),
        m("button", {onclick: ctrl.rotate}, "Rotate links")
    ];
};

Mia.protocolEdit = {};
Mia.protocolEdit.controller = function() {
  this.id = m.route.param('id') || 'nada';
  console.log(this.id);
}

Mia.protocolEdit.view = function(ctrl) {
  return m('h4', ctrl.id);
}


// m.module(document.body, Mia.app);
m.module(document.getElementById('toolbar'), Mia.toolbar);

m.route(document.getElementById('workarea'), '/login',
  {
    '/login': Mia.login,
    '/protocols' : Mia.protocols,
    '/protocols/edit/:id' : Mia.protocolEdit,
    '/protocols/create' : Mia.protocolEdit,
    '/runs': Mia.runs
   })
</script>

</html>
